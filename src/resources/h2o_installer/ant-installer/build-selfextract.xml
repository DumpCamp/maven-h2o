<project name="corvus" default="update-token" basedir=".">

	<tstamp />
	<property name="build.dir" value="../build" />
	<property name="dist.dir" value="../dist" />

	<path id="taskdef.cp">
		<fileset dir="${basedir}/lib">
			<include name="ant-installer.jar"/>
			<include name="ant-installer-ext.jar"/>			
		</fileset>
	</path>

	<taskdef name="UpdateToken" classname="droid.UpdateToken" classpath="../Droid/dist/droid.jar"/>
	<taskdef name="installer" classname="org.tp23.antinstaller.taskdefs.Installer" classpathref="taskdef.cp"/>

	<target name="update-token">
		<copy file="antinstall-config.xml" tofile="antinstall-config-new.xml" overwrite="true"/>
		<replace file="antinstall-config-new.xml" token="@version@" value="${DSTAMP}"/>				
		
		<!-- Modification for corvus webapp -->
		<UpdateToken src="${build.dir}/webapps/corvus/WEB-INF/classes/hk/hku/cecid/piazza/corvus/core/conf/corvus.properties.xml" string="/corvus/" replace="@coreDir@/" xpath="/corvus/home" />
		<UpdateToken src="${build.dir}/webapps/corvus/WEB-INF/classes/hk/hku/cecid/piazza/corvus/core/conf/corvus.properties.xml" string="/corvus/" replace="@convert@/" xpath="/corvus/plugin/registry" />
		<UpdateToken src="${build.dir}/webapps/corvus/WEB-INF/classes/hk/hku/cecid/piazza/corvus/core/conf/corvus.log.properties.xml" log="true" string="/corvus/" replace="@convert@/" xpath="//appender[attribute::name=&quot;corvus&quot;]/param[attribute::name=&quot;File&quot;]/@value" />

		<!-- Modification for ebms plugin -->
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.ebms/conf/hk/hku/cecid/ebms/spa/conf/log4j.properties.xml" log="true" string="/corvus/" replace="@convert@/" xpath="//appender[attribute::name=&quot;ebms&quot;]/param[attribute::name=&quot;File&quot;]/@value" />
		
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.ebms/conf/hk/hku/cecid/ebms/spa/conf/ebms.module.xml" string="org.postgresql.Driver" replace="@ebmsDriverClass@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;driver&quot;]/@value"/>
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.ebms/conf/hk/hku/cecid/ebms/spa/conf/ebms.module.xml" string="jdbc:postgresql://localhost:5432/ebms" replace="@ebmsConnStr@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;url&quot;]/@value" />		
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.ebms/conf/hk/hku/cecid/ebms/spa/conf/ebms.module.xml" string="corvus" replace="@ebmsuser@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;username&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.ebms/conf/hk/hku/cecid/ebms/spa/conf/ebms.module.xml" string="corvus" replace="@ebmspw@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;password&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.ebms/conf/hk/hku/cecid/ebms/spa/conf/ebms.module.xml" string="SELECT now()" replace="@ebmsValidationQuery@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;validationQuery&quot;]/@value"/>		
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.ebms/conf/hk/hku/cecid/ebms/spa/conf/ebms.module.xml" string="hk/hku/cecid/ebms/spa/conf/ebms.dao.xml" replace="@ebmsDAOFile@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;config&quot;]/."/>		
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.ebms/conf/hk/hku/cecid/ebms/spa/conf/ebms.module.xml" string="/corvus/" replace="@convert@/" xpath="//component[attribute::id=&quot;keystore-manager-for-signature&quot;]/parameter[attribute::name=&quot;keystore-location&quot;]/@value~//component[attribute::id=&quot;keystore-manager-for-decryption&quot;]/parameter[attribute::name=&quot;keystore-location&quot;]/@value" />

		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.ebms.admin/plugin.xml" string="hk.hku.cecid.ebms.admin.listener.MessageHistoryPageletAdaptor" replace="@ebmsPageletAdaptor@" xpath="//extension[attribute::name=&quot;Message History Pagelet Adaptor&quot;]/parameter[attribute::name=&quot;class&quot;]/@value" />

		<!-- Modification for as2 plugin -->
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2/conf/hk/hku/cecid/edi/as2/conf/as2.log.properties.xml" log="true" string="/corvus/" replace="@convert@/" xpath="//appender[attribute::name=&quot;as2&quot;]/param[attribute::name=&quot;File&quot;]/@value" />

		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="org.postgresql.Driver" replace="@as2DriverClass@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;driver&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="jdbc:postgresql://localhost:5432/as2" replace="@as2ConnStr@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;url&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="corvus" replace="@as2user@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;username&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="corvus" replace="@as2pw@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;password&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="SELECT now()" replace="@as2ValidationQuery@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;validationQuery&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="hk/hku/cecid/edi/as2/conf/as2.dao.xml" replace="@as2DAOFile@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;config&quot;]/@value" />		
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="/corvus/" replace="@convert@/" xpath="//component[attribute::id=&quot;outgoing-payload-repository&quot;]/parameter[attribute::name=&quot;location&quot;]/@value~//component[attribute::id=&quot;incoming-payload-repository&quot;]/parameter[attribute::name=&quot;location&quot;]/@value~//component[attribute::id=&quot;original-message-repository&quot;]/parameter[attribute::name=&quot;location&quot;]/@value" />

		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2.admin/plugin.xml" string="hk.hku.cecid.edi.as2.admin.listener.MessageHistoryPageletAdaptor" replace="@as2PageletAdaptor@" xpath="//extension[attribute::name=&quot;Message History Pagelet Adaptor&quot;]/parameter[attribute::name=&quot;class&quot;]/@value" />

		<!-- Modification for as2plus plugin version -->
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2plus/conf/hk/hku/cecid/edi/as2/conf/as2.log.properties.xml" log="true" string="/corvus/" replace="@convert@/" xpath="//appender[attribute::name=&quot;as2&quot;]/param[attribute::name=&quot;File&quot;]/@value" />

		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2plus/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="org.postgresql.Driver" replace="@as2DriverClass@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;driver&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2plus/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="jdbc:postgresql://localhost:5432/as2" replace="@as2ConnStr@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;url&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2plus/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="corvus" replace="@as2user@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;username&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2plus/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="corvus" replace="@as2pw@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;password&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2plus/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="SELECT now()" replace="@as2ValidationQuery@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;validationQuery&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2plus/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="hk/hku/cecid/edi/as2/conf/as2.dao.xml" replace="@as2DAOFile@" xpath="//component[attribute::id=&quot;daofactory&quot;]/parameter[attribute::name=&quot;config&quot;]/@value" />
		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2plus/conf/hk/hku/cecid/edi/as2/conf/as2.module.core.xml" string="/corvus/" replace="@convert@/" xpath="//component[attribute::id=&quot;outgoing-payload-repository&quot;]/parameter[attribute::name=&quot;location&quot;]/@value~//component[attribute::id=&quot;incoming-payload-repository&quot;]/parameter[attribute::name=&quot;location&quot;]/@value~//component[attribute::id=&quot;original-message-repository&quot;]/parameter[attribute::name=&quot;location&quot;]/@value" />

		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.edi.as2plus.admin/plugin.xml" string="hk.hku.cecid.edi.as2.admin.listener.MessageHistoryPageletAdaptor" replace="@as2PageletAdaptor@" xpath="//extension[attribute::name=&quot;Message History Pagelet Adaptor&quot;]/parameter[attribute::name=&quot;class&quot;]/@value" />

		<!-- Modification for admin plugin -->

		<UpdateToken src="${build.dir}/plugins/hk.hku.cecid.piazza.corvus.core.main.admin/conf/hk/hku/cecid/piazza/corvus/core/main/admin/conf/admin.logger.xml" string="/corvus/" replace="@convert@/" xpath="//appender[attribute::name=&quot;admin.main&quot;]/param[attribute::name=&quot;File&quot;]/@value" log="true" />


		<!-- Modification for loopback test -->
		<!--
		<UpdateToken src="${build.dir}/test/conf/partnership.log.properties.xml" log="true" string="/corvus/" replace="@convert@/" xpath="//appender[attribute::name=&quot;corvus&quot;]/param[attribute::name=&quot;File&quot;]/@value" />

		<UpdateToken src="${build.dir}/test/conf/partnership.module.core.xml" string="jdbc:postgresql://localhost:5432/ebms" replace="@ebmsConnStr@" xpath="//component[attribute::id=&quot;ebms-daofactory&quot;]/parameter[attribute::name=&quot;url&quot;]/@value" />
		<UpdateToken src="${build.dir}/test/conf/partnership.module.core.xml" string="corvus" replace="@ebmsuser@" xpath="//component[attribute::id=&quot;ebms-daofactory&quot;]/parameter[attribute::name=&quot;username&quot;]/@value" />
		<UpdateToken src="${build.dir}/test/conf/partnership.module.core.xml" string="corvus" replace="@ebmspw@" xpath="//component[attribute::id=&quot;ebms-daofactory&quot;]/parameter[attribute::name=&quot;password&quot;]/@value" />
		<UpdateToken src="${build.dir}/test/conf/partnership.module.core.xml" string="org.postgresql.Driver" replace="@ebmsDriverClass@" xpath="//component[attribute::id=&quot;ebms-daofactory&quot;]/parameter[attribute::name=&quot;driver&quot;]/@value" />
		<UpdateToken src="${build.dir}/test/conf/partnership.module.core.xml" string="SELECT now()" replace="@ebmsValidationQuery@" xpath="//component[attribute::id=&quot;ebms-daofactory&quot;]/parameter[attribute::name=&quot;validationQuery&quot;]/@value" />
		
		<UpdateToken src="${build.dir}/test/conf/partnership.module.core.xml" string="jdbc:postgresql://localhost:5432/as2" replace="@as2ConnStr@" xpath="//component[attribute::id=&quot;as2-daofactory&quot;]/parameter[attribute::name=&quot;url&quot;]/@value" />
		<UpdateToken src="${build.dir}/test/conf/partnership.module.core.xml" string="corvus" replace="@as2user@" xpath="//component[attribute::id=&quot;as2-daofactory&quot;]/parameter[attribute::name=&quot;username&quot;]/@value" />
		<UpdateToken src="${build.dir}/test/conf/partnership.module.core.xml" string="corvus" replace="@as2pw@" xpath="//component[attribute::id=&quot;as2-daofactory&quot;]/parameter[attribute::name=&quot;password&quot;]/@value" />
		<UpdateToken src="${build.dir}/test/conf/partnership.module.core.xml" string="org.postgresql.Driver" replace="@as2DriverClass@" xpath="//component[attribute::id=&quot;as2-daofactory&quot;]/parameter[attribute::name=&quot;driver&quot;]/@value" />
		<UpdateToken src="${build.dir}/test/conf/partnership.module.core.xml" string="SELECT now()" replace="@as2ValidationQuery@" xpath="//component[attribute::id=&quot;as2-daofactory&quot;]/parameter[attribute::name=&quot;validationQuery&quot;]/@value" />
		-->
	</target>
	
	<target name="installer">
		<installer file="${dist.dir}/hermes2_installer.jar" compress="true"
			extractType="SelfExtractor"
			installConfig="antinstall-config.xml"
			buildFile="build.xml"
			antInstallLib="${basedir}/lib"
			antLib="${basedir}/antlib"
			validateConfig="true"
			failOnError="true">
			<fileset dir="${dist.dir}" includes="hermes2_bin.zip"/>
			<fileset dir="." includes="resources/*"/>
			<fileset dir="." includes="resources/lib/*"/>
			<fileset dir="." includes="resources/icons/*"/>
		</installer>
	</target>	

</project>
